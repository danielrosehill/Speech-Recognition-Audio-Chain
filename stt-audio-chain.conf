# PipeWire Filter Chain Configuration for Speech-to-Text
# Optimized for: Samson Q2U and similar dynamic microphones
# Based on analysis of voice-samples/raw-q2u.wav (131 seconds)
#
# Processing chain: HPF → Gate → Dereverb → AGC → De-ess → Limiter
# Tuned for: Lightweight processing, preserving natural voice characteristics
# SNR: 42 dB | Speech variation: 2.04 dB std | Sibilance: 2.6%
# Works with both mono and stereo microphones

context.modules = [
    {   name = libpipewire-module-filter-chain
        args = {
            node.description = "STT Microphone Audio Chain"
            media.name       = "STT Microphone Audio Chain"
            audio.channels   = 1
            audio.position   = [ MONO ]
            filter.graph = {
                nodes = [
                    # 1. High-pass filter to remove rumble and low-frequency noise
                    {
                        type   = ladspa
                        name   = hpf
                        plugin = "highpass_iir_1890"
                        label  = highpass_iir
                        control = {
                            "Cutoff Frequency"         = 80.0  # Remove frequencies below 80 Hz
                            "Stages(2 poles per stage)" = 2.0   # 4-pole filter (12 dB/octave)
                        }
                    }

                    # 2. Noise gate to suppress background noise during silence
                    # Tuned for SNR 42 dB with periodic disturbances
                    {
                        type   = ladspa
                        name   = gate
                        plugin = "gate_1410"
                        label  = gate
                        control = {
                            "Threshold (dB)"      = -45.0  # Moderate gate for background noise
                            "Attack (ms)"         = 5.0    # Fast attack to catch speech onset
                            "Hold (ms)"           = 150.0  # Longer hold to avoid chopping
                            "Decay (ms)"          = 150.0  # Smooth release
                            "Range (dB)"          = -30.0  # Attenuation during gate
                        }
                    }

                    # 3. De-reverb using gentle low-pass filter
                    # (Reduces room reflections by rolling off high frequencies)
                    {
                        type   = ladspa
                        name   = dereverb_lpf
                        plugin = "lowpass_iir_1891"
                        label  = lowpass_iir
                        control = {
                            "Cutoff Frequency"         = 8000.0  # Roll off above 8kHz
                            "Stages(2 poles per stage)" = 1.0     # 2-pole filter (gentle slope)
                        }
                    }

                    # 4. Simple compressor for AGC (using mono version)
                    # Gentle compression - speaker has excellent natural consistency (2.04 dB std)
                    {
                        type   = ladspa
                        name   = compressor
                        plugin = "sc1_1425"
                        label  = sc1
                        control = {
                            "Attack time (ms)"   = 10.0    # Fast attack
                            "Release time (ms)"  = 150.0   # Moderate release
                            "Threshold level (dB)" = -22.0 # Just above avg speech (-22.65 dB)
                            "Ratio (1:n)"        = 3.5     # Gentle 3.5:1 compression
                            "Knee radius (dB)"   = 6.0     # Soft knee for smooth transition
                            "Makeup gain (dB)"   = 5.0     # Conservative makeup gain
                        }
                    }

                    # 5. Simple limiter to prevent clipping
                    {
                        type   = ladspa
                        name   = limiter
                        plugin = "hard_limiter_1413"
                        label  = hardLimiter
                        control = {
                            "Limit (dB)" = -1.0  # Limit at -1 dB to prevent clipping
                        }
                    }
                ]
                links = [
                    { output = "hpf:Output" input = "gate:Input" }
                    { output = "gate:Output" input = "dereverb_lpf:Input" }
                    { output = "dereverb_lpf:Output" input = "compressor:Input" }
                    { output = "compressor:Output" input = "limiter:Input" }
                ]
            }
            capture.props = {
                node.name      = "stt_audio_chain_capture"
                media.class    = Audio/Source
                audio.position = [ MONO ]
            }
            playback.props = {
                node.name      = "stt_audio_chain_playback"
                media.class    = Audio/Sink
                audio.position = [ MONO ]
                node.passive   = true
            }
        }
    }
]
